{$MINIO_ADDRESS} {
  import ../caddy-common.conf

  header / {
    X-Robots-Tag noindex
    -X-Amz-Meta-mtime
    -X-Amz-Request-Id
    -X-Minio-Deployment-Id
    # All the images are immutable, set max-age to 1 year
    # immutable is not supported in chrome
    # https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Cache-Control#Browser_compatibility
    Cache-Control public, max-age=31536000, immutable
  }

  # Legacy: root redirect
  rewrite /uploads {
    r (.*)
    to {1}
  }

  # Legacy: This loads full images instead of thumbs
  rewrite /images {
    r ^/\w+/(.*)$
    to /{1}
  }

  proxy /{$IMGPROXY_PATH} imageproxy:8080 {
   without /{$IMGPROXY_PATH}
   transparent
  }

  proxy / minio:9000 {
    header_downstream Access-Control-Expose-Headers Location
    transparent
    health_check /minio/health/ready
  }

  # Important note:
  # other paths will be cached to, based on their headers (Cache-control, Expires, Last-Modified)
  cache {
    match_path /{$IMGPROXY_PATH}
    match_header Content-Type image/jpg image/png image/*
    status_header X-Cache-Status
    default_max_age 1y
    path {$CADDY_CACHE_PATH}
  }

}
