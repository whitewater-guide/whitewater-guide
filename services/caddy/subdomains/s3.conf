{$MINIO_ADDRESS} {
  import ../caddy-common.conf

  header / {
    X-Robots-Tag noindex
    Cache-Control public
    # All the images are immutable, set max-age to 1 year
    +Cache-Control max-age=31536000
    # immutable is not supported in chrome
    # https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Cache-Control#Browser_compatibility
    +Cache-Control immutable
    -Server
  }

  # Legacy: root redirect
  rewrite /uploads {
    r (.*)
    to {1}
  }

  # Legacy: This loads full images instead of thumbs
  rewrite /images {
    r ^/\w+/(.*)$
    to /{1}
  }

  # Caddy cache is impossible to use.
  # I couldn't configure it to cache imageproxy and NOT to cache original files from minio
  # Therefore, intermediate nginx was added for caching
  proxy /{$IMGPROXY_PATH} imagecache:8080 {
   without /{$IMGPROXY_PATH}
   transparent
  }

  proxy / minio:9000 {
    header_downstream Access-Control-Expose-Headers Location
    header_downstream -Server
    header_downstream -X-Amz-Meta-mtime
    header_downstream -X-Amz-Request-Id
    header_downstream -X-Minio-Deployment-Id

    transparent
    health_check /minio/health/ready
  }

}
