{$MINIO_ADDRESS} {
  import ../caddy-common.conf

  header / {
    X-Robots-Tag noindex
  }

  # rewrite for legacy root redirect
  rewrite /uploads {
    r (.*)
    to {1}
  }

  proxy / minio:9000 {
    header_downstream Access-Control-Expose-Headers Location
    transparent
    # header_upstream -Authorization
    # header_upstream -Cookie
    health_check /minio/health/ready
  }

  # This loads full images instead of thumbs
  # rewrite /images {
  #   r ^/\w+/(.*)$
  #   to /{1}
  # }

  proxy /images imageproxy:8080 {
   without /images
   transparent
  }

  # Cache is temporary disabled, because sometimes it returns empty images: https://github.com/nicolasazrak/caddy-cache/issues/28
  # Important note:
  # other paths will be cached to, based on their headers (Cache-control, Expires, Last-Modified)
  # cache {
  #   match_path /images
  #   match_header Content-Type image/jpg image/png image/*
  #   status_header X-Cache-Status
  #   default_max_age 24h
  #   path {$CADDY_CACHE_PATH}
  # }

}
