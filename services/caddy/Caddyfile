import subdomains/*

{$ROOT_ADDRESS} {
  import caddy-common.conf

  gzip

  # legacy redirect
  redir 301 {
    if {path} starts_with /admin
    / {$ADMIN_ADDRESS}
  }
  # legacy redirect. 307 to keep POST
  redir 307 {
    if {path} starts_with /graphql
    if {path} starts_with /auth
    if_op or

    / {$API_ADDRESS}{uri}
  }

  # Root is landing
  rewrite / {
    if {path} is /
    if {path} is /index.html
    if_op or
    to /landing.html
  }

  # russian landing
  rewrite / {
    if {path} starts_with /ru
    to {path} landing_ru.html
  }

  proxy /boompromo boompromo:8043 {
    without /boompromo
    transparent
  }

  proxy / landing:8043 {
    transparent
  }

}
