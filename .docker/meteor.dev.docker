# Based on https://github.com/golden-garage/meteor-dev

FROM ubuntu:latest

LABEL description="whitewater dev"
LABEL version="1.0"

# build arguments
ARG APP_USER=wwuser
ARG APP_USER_DIR=/home/${APP_USER}

ENV MONGO_URL mongodb://mongo:27017/whitewater

EXPOSE 3000

# add packages for building NPM modules (required by Meteor)
RUN DEBIAN_FRONTEND=noninteractive apt-get update \
                                && apt-get install -y curl python build-essential wget \
                                && apt-get autoremove \
                                && apt-get clean

ENV DOCKERIZE_VERSION v0.3.0
RUN wget https://github.com/jwilder/dockerize/releases/download/$DOCKERIZE_VERSION/dockerize-linux-amd64-$DOCKERIZE_VERSION.tar.gz \
    && tar -C /usr/local/bin -xzvf dockerize-linux-amd64-$DOCKERIZE_VERSION.tar.gz \
    && rm dockerize-linux-amd64-$DOCKERIZE_VERSION.tar.gz

# set the locale (required by Meteor)
RUN localedef en_US.UTF-8 -i en_US -f UTF-8

# create a non-root user that can write to /usr/local (required by Meteor)
RUN useradd -mUd ${APP_USER_DIR} ${APP_USER}
RUN chown -Rh ${APP_USER} /usr/local
USER ${APP_USER}

# install Meteor
RUN curl https://install.meteor.com/ | sh

# run Meteor from the app directory
WORKDIR /var/www/whitewater
ENTRYPOINT [ "dockerize", "-wait", "tcp://mongo:27017", "/usr/local/bin/meteor", "--settings", "settings.development.json"]