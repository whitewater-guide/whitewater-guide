{$CADDY_ADDRESS} {

  tls {$CADDY_TLS_EMAIL} {
    # The line below uses staging certificate
    # Comment it out to use real certificate
    ca https://acme-staging.api.letsencrypt.org/directory
  }

  root static

  header / {
    -Server
  }

  index landing.html

  rewrite / {
    if {path} starts_with /graphql
    if {path} starts_with /graphiql
    if {path} starts_with /auth
    if {file} is schema.json
    if {file} is typedefs.txt
    if_op or
    to /backend{uri}
  }

  rewrite /ru {
    to {path} landing_ru.html
  }

  proxy /backend backend:3333 {
    without /backend
    transparent
  }

  proxy /{$MINIO_PROXY_PATH} minio:9000 {
    without /{$MINIO_PROXY_PATH}
    header_downstream Access-Control-Expose-Headers Location
    transparent
  }

  proxy /{$IMGPROXY_PATH} imgproxy:8080 {
    without /{$IMGPROXY_PATH}
    transparent
  }

  # cache {
  #   match_path /${IMGPROXY_PATH}
  #   match_header Content-Type image/jpg image/png
  #   status_header X-Cache-Status
  #   default_max_age 24h
  #   path {$CADDY_CACHE_PATH}
  # }

  log / stdout "{common} Upstream: {upstream}"

  errors stdout

}
