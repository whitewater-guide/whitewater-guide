{$CADDY_ADDRESS} {

  tls {$CADDY_TLS_EMAIL} {
    # The line below uses staging certificate
    # Comment it out to use real certificate
    # ca https://acme-staging-v02.api.letsencrypt.org/directory
  }

  header / {
    -Server
  }

  gzip {
    ext .css .html .js
    min_length 2048
  }

  # All backend URIs
  rewrite / {
    if {path} starts_with /graphql
    if {path} starts_with /graphiql
    if {path} starts_with /auth
    if {file} is schema.json
    if {file} is typedefs.txt
    if_op or
    to /backend{uri}
  }

  # admin uris without extensions => react router
  rewrite /admin {
    ext /
    to /web/admin
  }

  # admin static assets
  rewrite /admin {
    to /web{uri}
  }

  # Root is landing
  rewrite / {
    if {path} is /
    if {path} is /index.html
    if_op or
    to /landing.html
  }

  # russian landing
  rewrite / {
    if {path} starts_with /ru
    to {path} landing_ru.html
  }

  proxy /backend backend:3333 {
    without /backend
    transparent
  }

  proxy /{$MINIO_PROXY_PATH} minio:9000 {
    without /{$MINIO_PROXY_PATH}
    header_downstream Access-Control-Expose-Headers Location
    transparent
    header_upstream -Authorization
    header_upstream -Cookie
  }

  proxy /images imageproxy:8080 {
    without /images
    transparent
  }

  proxy /web web:8043 {
    without /web/admin
    transparent
  }

  proxy /boompromo boompromo:8043 {
    without /boompromo
    transparent
  }

  basicauth /puzzle {$ADMINER_USERNAME} {$ADMINER_PASSWORD}

  proxy /puzzle adminer:8080 {
    without /puzzle
    transparent
  }

  proxy / landing:8043 {
    transparent
  }

  cache {
    match_path /${IMGPROXY_PATH}
    match_header Content-Type image/jpg image/png
    status_header X-Cache-Status
    default_max_age 24h
    path {$CADDY_CACHE_PATH}
  }

  log / stdout "{common} Upstream: {upstream}"

  errors stdout

}
