version: '3.6'

services:

  # Node.js backend
  backend:
    container_name: ww-backend
    image: 'ww-backend:dev'
    build:
      dockerfile: Dockerfile.development
    ports:
      - '5775:5775'
      - '3333:3333'
    volumes:
      - type: volume
        source: yarn
        target: /root/.cache/yarn
      - type: bind
        source: ../packages/backend/dist
        target: /opt/app/dist
        volume:
          nocopy: true
      - type: bind
        source: ../packages/backend/package.json
        target: /opt/app/package.json
      - type: bind
        source: ../packages/backend/yarn.lock
        target: /opt/app/yarn.lock
      - type: bind
        source: ../packages/backend/pm2.development.json
        target: /opt/app/pm2.development.json

  # Postgres sql database
  db:
    container_name: ww-db
    image: 'ww-db:dev'
    volumes:
      - type: tmpfs
        target: /tmp
      - type: tmpfs
        target: /run/postgresql
      - type: tmpfs
        target: /var/lib/postgresql/data
      - type: bind
        source: ../packages/db/config/dump.bak
        target: /docker-entrypoint-initdb.d/dump.bak
      - type: bind
        source: ../packages/db/config/x-dev-restore.sh
        target: /docker-entrypoint-initdb.d/x-dev-restore.sh
    environment:
      - NODE_ENV=development # This is needed to created test db
    ports:
      - '5432:5432'

  # Minio to store images
  minio:
    container_name: ww-minio
    ports:
      - '9001:9000'
    volumes:
      - type: bind
        source: ../packages/minio/data
        target: /data
      - type: bind
        source: ../packages/minio/config
        target: /root/.minio

  # Caddy reverse proxy
  caddy:
    container_name: ww-caddy
    image: 'ww-caddy:dev'
    tmpfs:
      - /tmp/caddy-cache
    volumes:
      - '../packages/caddy/Caddyfile:/etc/Caddyfile'
    ports:
      - '6001:2015'

  # imageproxy to generate thumbnails
  imageproxy:
    container_name: ww-imageproxy
    command:
      - -verbose
      - -addr
      - 0.0.0.0:8080
      - -whitelist
      - minio:9000
      - -baseURL
      - http://minio:9000/
    ports:
      - '8082:8080'

  # Redis for sessions and last measurements
  redis:
    container_name: ww-redis
    ports:
      - '6379:6379'
    volumes:
      - type: tmpfs
        target: /data

  # Workers to harvest some data
  workers:
    container_name: ww-workers
    image: 'ww-workers:dev'
    ports:
      - '7080:7080'
    volumes:
      - type: tmpfs
        target: /tmp
volumes:
  yarn:
    labels:
      guide.whitewater: ""
#  Docker-sync is temporary off
#  ww-sync:
#    external: true
