version: '3.4'

x-single-host:
  &ww-single-host
  deploy:
    placement:
      constraints: [node.role == manager]
  labels:
    guide.whitewater: ""

services:
  backend:
    <<: *ww-single-host
    env_file:
      - ${DOCKER_ENV_FILE}
      - ../packages/backend/${DOCKER_ENV_FILE}
    build:
      context: ../packages/backend
      labels:
        guide.whitewater: ""
    depends_on:
      - db
      - redis
      - minio
      - workers
  db:
    <<: *ww-single-host
    env_file:
      - ${DOCKER_ENV_FILE}
    environment:
      - PGDATA=/var/lib/postgresql/data/pgdata
    build:
      context: ../packages/db
      labels:
        guide.whitewater: ""
    read_only: true
  minio:
    <<: *ww-single-host
    env_file:
      - ${DOCKER_ENV_FILE}
    read_only: true
  imgproxy:
    <<: *ww-single-host
    env_file:
      - ${DOCKER_ENV_FILE}
    environment:
      - IMGPROXY_TTL=86400
      - IMGPROXY_USE_ETAG=true
    image: 'darthsim/imgproxy:latest'
    read_only: true
  workers:
    <<: *ww-single-host
    env_file:
      - ${DOCKER_ENV_FILE}
      - ../packages/workers/${DOCKER_ENV_FILE}
    build:
      context: ../packages/workers
      labels:
        guide.whitewater: ""
    read_only: true
    volumes:
      - type: tmpfs
        target: /tmp/cookies
    depends_on:
      - db
      - redis
  caddy:
    <<: *ww-single-host
    env_file:
      - ${DOCKER_ENV_FILE}
      - ../packages/caddy/${DOCKER_ENV_FILE}
    build:
      context: ../packages
      dockerfile: caddy/Dockerfile
      labels:
        guide.whitewater: ""
    read_only: true
  redis:
    # TODO: password, aof-use-rdb-preamble, etc...
    # TODO: read_only: true
    <<: *ww-single-host
    env_file:
      - ${DOCKER_ENV_FILE}
    image: redis:4-alpine
