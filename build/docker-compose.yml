version: '3.5'

x-single-host:
  &ww-single-host
  deploy:
    placement:
      constraints: [node.role == manager]
  labels:
    guide.whitewater: ""

services:
  backend:
    <<: *ww-single-host
    env_file:
      - ${DOCKER_ENV_FILE}
    build:
      context: ../packages/backend
      args:
        # This should be known during build stage, so we know where to put workers from multi-stage build
        BACK_WORKERS_PATH: ${BACK_WORKERS_PATH}
        # This should be known during build stage so we copy proper version of workers
        WORKERS_TAG: ${WORKERS_TAG} #
      labels:
        guide.whitewater: ""
    depends_on:
      - db
      - minio
  db:
    <<: *ww-single-host
    env_file:
      - ${DOCKER_ENV_FILE}
    build:
      context: ../packages/db
      labels:
        guide.whitewater: ""
    read_only: true
  minio:
    <<: *ww-single-host
    env_file:
      - ${DOCKER_ENV_FILE}
    read_only: true
  imgproxy:
    <<: *ww-single-host
    env_file:
      - ${DOCKER_ENV_FILE}
    image: 'darthsim/imgproxy:latest'
    read_only: true
  caddy:
    <<: *ww-single-host
    env_file:
      - ${DOCKER_ENV_FILE}
    build:
      context: ../packages/caddy
      labels:
        guide.whitewater: ""
    read_only: true
